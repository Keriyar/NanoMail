import { VerticalBox, ScrollView } from "std-widgets.slint";
import { Theme } from "themes/colors.slint";
export { Theme }
import { IconButton } from "components/icon_button.slint";
import { Badge } from "components/badge.slint";
import { AccountCard } from "components/account_card.slint";

// 数据结构
export struct Account {
    email: string,
    display-name: string,
    avatar-image: image,
    unread-count: int,
    is-loading: bool,
    has-error: bool,
}

export component MainWindow inherits Window {
    // ===== 属性 =====
    in-out property <[Account]> accounts: [];
    in property <string> theme: "light";

    // 应用状态("normal" | "unread" | "error")
    in-out property <string> app-status: "normal";

    // ===== 回调 =====
    callback theme-toggled();
    callback add-account-clicked();
    callback open-gmail-clicked();
    callback feedback-clicked();
    callback minimize-clicked();
    callback avatar-retry(int /* account index */);

    // ===== 颜色计算函数 =====
    pure function get-status-color() -> color {
        if (app-status == "unread") {
            return Theme.status-unread;
        } else if (app-status == "error") {
            return Theme.status-error;
        } else {
            return Theme.status-normal;
        }
    }

    // ===== 窗口配置 =====
    title: "NanoMail";
    width: 380px;
    height: 60px + 1px + max(80px, accounts.length * 80px) + 1px + 60px;
    no-frame: true;
    background: transparent;  // 透明背景以支持圆角和阴影效果

    // ===== 主容器 =====
    Rectangle {
        background: Theme.background;
        border-radius: 0;  // 直角窗口
        border-width: 0.5px;
        border-color: Theme.border;

        // 多层阴影系统 - 模拟 macOS 真实阴影
        drop-shadow-blur: 48px;
        drop-shadow-color: Theme.shadow-light;
        drop-shadow-offset-y: 16px;

        VerticalLayout {
            padding: 0px;
            spacing: 0px;

            // ===== 标题栏 (60px) =====
            Rectangle {
                height: 60px;
                background: transparent;  // 磨砂效果

                VerticalLayout {
                    alignment: center;  // 垂直居中

                    HorizontalLayout {
                        padding-left: 20px;
                        padding-right: 20px;
                        spacing: 12px;

                        // "Nano Notification" 标题("N"动态着色)
                        HorizontalLayout {
                            spacing: 0px;

                            Text {
                                text: "N";
                                color: get-status-color();
                                font-size: 18px;
                                font-weight: 600;  // macOS 标准粗细
                                vertical-alignment: center;
                            }

                            Text {
                                text: "ano Notification";
                                color: Theme.text-primary;
                                font-size: 18px;
                                font-weight: 600;
                                vertical-alignment: center;
                            }
                        }

                        // 弹簧
                        Rectangle { }

                        // 主题切换按钮（亮色显示月亮，暗色显示太阳）
                        IconButton {
                            icon: Theme.is-dark
                                ? @image-url("../assets/icons/sun.svg")
                                : @image-url("../assets/icons/moon.svg");
                            clicked => { root.theme-toggled(); }
                        }

                        // 信封图标(打开Gmail)
                        IconButton {
                            icon: @image-url("../assets/icons/envelope.svg");
                            clicked => { root.open-gmail-clicked(); }
                        }
                    }
                }
            }

            // ===== 分隔线 =====
            Rectangle {
                height: 1px;
                background: Theme.separator;
            }

            // ===== 账户列表区域 =====
            ScrollView {
                VerticalLayout {
                    spacing: 0px;

                    for account[index] in accounts: AccountCard {
                        account: account;
                        avatar-clicked => {
                            root.avatar-retry(index);
                        }
                    }
                }
            }

            // ===== 分隔线 =====
            Rectangle {
                height: 1px;
                background: Theme.separator;
            }

            // ===== 操作栏 (60px) =====
            Rectangle {
                height: 60px;
                background: transparent;

                HorizontalLayout {
                    alignment: center;
                    spacing: 40px;

                    // 加号按钮(添加账户)
                    IconButton {
                        icon: @image-url("../assets/icons/plus.svg");
                        clicked => { root.add-account-clicked(); }
                    }

                    // Bug按钮(反馈)
                    IconButton {
                        icon: @image-url("../assets/icons/bug.svg");
                        clicked => { root.feedback-clicked(); }
                    }

                    // 隐藏到托盘(最小化/隐藏)按钮
                    IconButton {
                        icon: @image-url("../assets/icons/arrow-left.svg");
                        clicked => { root.minimize-clicked(); }
                    }
                }
            }
        }
    }
}
